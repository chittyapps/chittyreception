#!/bin/bash
# Pre-commit hook to prevent clutter from being committed
# Install: cp .github/pre-commit.sample .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

echo "üîç Running pre-commit checks..."

# Check for log files
if ls *.log >/dev/null 2>&1; then
  echo "‚ùå Log files found in root directory:"
  ls -1 *.log
  echo "   Remove them before committing."
  exit 1
fi

# Check for temporary files
if find . -maxdepth 1 -name "*.tmp" -o -name "*.temp" | grep -q .; then
  echo "‚ùå Temporary files found:"
  find . -maxdepth 1 -name "*.tmp" -o -name "*.temp"
  echo "   Remove them before committing."
  exit 1
fi

# Check for backup files
if find . -maxdepth 1 -name "*.bak" -o -name "*.old" -o -name "*.obsolete" | grep -q .; then
  echo "‚ùå Backup files found:"
  find . -maxdepth 1 -name "*.bak" -o -name "*.old" -o -name "*.obsolete"
  echo "   Remove them before committing."
  exit 1
fi

# Check for wrong package manager lock files
if [ -f package-lock.json ]; then
  echo "‚ùå package-lock.json found"
  echo "   This project uses pnpm. Run: rm package-lock.json && pnpm install"
  exit 1
fi

if [ -f yarn.lock ]; then
  echo "‚ùå yarn.lock found"
  echo "   This project uses pnpm. Run: rm yarn.lock && pnpm install"
  exit 1
fi

# Check for .env files
if git diff --cached --name-only | grep -E "^\.env$"; then
  echo "‚ùå Attempting to commit .env file"
  echo "   This contains secrets and should not be committed."
  echo "   Use .env.example instead."
  exit 1
fi

# Type check
echo "üìù Running TypeScript type check..."
if ! pnpm typecheck; then
  echo "‚ùå TypeScript errors found"
  echo "   Fix type errors before committing."
  exit 1
fi

# Check for large files (>1MB)
echo "üìä Checking for large files..."
while IFS= read -r file; do
  if [ -f "$file" ]; then
    size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
    if [ "$size" -gt 1048576 ]; then
      echo "‚ö†Ô∏è  Large file detected: $file ($(($size / 1024))KB)"
      echo "   Consider if this should be committed or added to .gitignore"
    fi
  fi
done < <(git diff --cached --name-only)

echo "‚úÖ Pre-commit checks passed!"
